<system>
  log_level info
</system>

# Docker Fluentd input
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Syslog capture (e.g., system logs)
<source>
  @type syslog
  port 5140
  bind 0.0.0.0
  tag syslog
</source>

# Fluentd own log for health monitoring (optional)
<source>
  @type http
  port 9880
  bind 0.0.0.0
</source>

# Capture log file of FastAPI
<source>
  @type tail
  path /var/log/fastapi_app.log
  pos_file /fluentd/log/fastapi_app.pos
  tag fastapi.logfile
  format none
</source>

# Enrich logs with hostname
<filter **>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    tag ${tag}
  </record>
</filter>

# Output to Loki
<match **>
  @type loki
  url http://loki:3100
  username ""
  password ""
  extra_labels {"job":"fluentd"}
  <label>
    container $.container_name
    source $.source
  </label>
  <buffer>
    @type file
    path /fluentd/log/loki
    flush_mode interval
    flush_interval 10s
    chunk_limit_size 1m
  </buffer>
</match>
